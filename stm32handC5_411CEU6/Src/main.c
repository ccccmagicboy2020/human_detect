/* USER CODE BEGIN Header */


/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "sys.h"
#include "crc.h"
#include "usart.h"
#include "gpio.h"
#include "app_x-cube-ai.h"
#include "stdio.h"
#include "adc.h"
#include "timer.h"
#include "math.h" 
#include "arm_math.h" 
#include "delay.h"
#include "led.h"
#include "hamming.h"
#include "auto_trip_50hz.h"

#define  FFT_LENGTH		2048		//FFT长度

extern u8 change_flag;

u16 num ;
float  adc_data = 0;
extern float in_data[2048];  
extern const float hamming_TAB1[2048];

float fft_inputbuf[FFT_LENGTH*2], fft_outputbuf[FFT_LENGTH];	//FFT输入数组//FFT输出数组




//u8 status=0,Key=0,Key1=0;
//u16 t1[60][90]={0};
//u16 t[256]= {0} ;
//u16 t2[60] ={0};


void measure_fft(void)
{
			arm_cfft_radix2_instance_f32 scfft;
			u32 temp_val=0,temp=0,fft_value=0;
			u16 i,b,c,t,adc_value=0;
	
	//			 for(num=0;num<2560;num++)
	//			 {
	//							adc_data = in_data[num]; 
	//							printf("%d ",adc_data);	
	//			 }
	//			 printf("END \r\n");
	//    for(t=0;t<2048;t++)
	//		{
	//			adc_data = hamming_TAB1[t];
	//			printf("%f  ",adc_data);
	//		}
	//		 printf("END \r\n");
			for(t=0;t<2048;t++)
			{
				adc_value = in_data[t]; 
				temp_val+=adc_value;
		
			}	
			temp = temp_val/2048;
	//    printf("temp=%d \r\n", temp);
			for(t=0;t<2048;t++)
			{
				in_data[t] = (in_data[t]-temp) ;
				in_data[t] = in_data[t] *hamming_TAB1[t];
	//			adc_data = in_data[t];
	//			printf("%.2f  ",adc_data);	
			}		
	//	  printf("END \r\n");
			arm_cfft_radix2_init_f32(&scfft,2048,0,1);//初始化scfft结构体，设定FFT相关参数


			for(b=0;b<2048;b++)
			{
					
					fft_inputbuf[2*b] = in_data[b];
					fft_inputbuf[2*b+1]=0;//虚部全部为0
					//  printf("%d \r",AD_FFT[b] );
			}

			
			arm_cfft_radix2_f32(&scfft,fft_inputbuf);	//FFT计算（基2）
			arm_cmplx_mag_f32(fft_inputbuf,fft_outputbuf,2048);	
					
//			for(i=0;i<2048;i++)
//			{
//					fft_value = fft_outputbuf[i];
//				
//					printf("%d ",fft_value);					
//			}
//			printf("END \r\n");
			for(c=1;c<2048;c++)
			{
				  fft_value = fft_outputbuf[i];
				  fft_outputbuf[i] = fft_value*2;
			}
			


}

const double src[2560]=
{845.326,943.326,1001.326,1034.326,1034.326,1022.326,976.326,873.326,783.326,661.326,598.326,536.326,481.326,427.326,317.326,219.326,43.326,-222.674,-450.674,-618.674,-708.674,-738.674,-771.674,-761.674,-726.674,-651.674,-428.674,-147.674,157.326,337.326,431.326,430.326,311.326,184.326,-8.674,-180.674,-244.674,-331.674,-162.674,-22.674,183.326,362.326,362.326,424.326,337.326,284.326,302.326,297.326,479.326,576.326,732.326,875.326,850.326,809.326,597.326,285.326,-43.674,-457.674,-636.674,-709.674,-737.674,-727.674,-740.674,-745.674,-778.674,-789.674,-788.674,-781.674,-725.674,-597.674,-223.674,304.326,718.326,1017.326,1110.326,1143.326,1170.326,1151.326,1127.326,1037.326,807.326,436.326,19.326,-350.674,-610.674,-736.674,-791.674,-834.674,-842.674,-817.674,-794.674,-712.674,-519.674,-98.674,253.326,391.326,463.326,366.326,213.326,82.326,-176.674,-364.674,-581.674,-675.674,-716.674,-743.674,-744.674,-742.674,-716.674,-610.674,-405.674,15.326,413.326,746.326,992.326,1054.326,1085.326,1080.326,1045.326,1015.326,882.326,756.326,615.326,480.326,487.326,540.326,667.326,853.326,966.326,1034.326,1039.326,1027.326,933.326,682.326,371.326,-94.674,-511.674,-682.674,-747.674,-742.674,-721.674,-615.674,-397.674,-165.674,83.326,147.326,97.326,-90.674,-451.674,-659.674,-743.674,-787.674,-793.674,-789.674,-756.674,-723.674,-661.674,-604.674,-592.674,-597.674,-643.674,-681.674,-711.674,-737.674,-737.674,-731.674,-684.674,-528.674,-265.674,148.326,442.326,657.326,853.326,872.326,883.326,801.326,610.326,444.326,170.326,16.326,-139.674,-232.674,-213.674,-223.674,-149.674,-150.674,-169.674,-100.674,-85.674,75.326,270.326,426.326,632.326,735.326,810.326,814.326,749.326,671.326,552.326,426.326,355.326,238.326,226.326,180.326,198.326,227.326,140.326,125.326,31.326,-51.674,-169.674,-400.674,-499.674,-623.674,-665.674,-704.674,-730.674,-738.674,-756.674,-770.674,-776.674,-789.674,-791.674,-797.674,-806.674,-804.674,-811.674,-805.674,-803.674,-798.674,-784.674,-763.674,-718.674,-626.674,-534.674,-333.674,-200.674,-64.674,43.326,49.326,108.326,125.326,169.326,252.326,296.326,403.326,470.326,536.326,630.326,618.326,636.326,571.326,484.326,412.326,248.326,206.326,22.326,172.326,298.326,446.326,554.326,629.326,710.326,726.326,748.326,735.326,674.326,629.326,550.326,499.326,430.326,375.326,345.326,246.326,168.326,70.326,-84.674,-150.674,-272.674,-300.674,-331.674,-347.674,-342.674,-347.674,-332.674,-279.674,-284.674,-252.674,-218.674,-160.674,-93.674,-66.674,39.326,89.326,172.326,263.326,279.326,337.326,311.326,344.326,361.326,294.326,294.326,234.326,222.326,223.326,159.326,167.326,140.326,146.326,176.326,123.326,157.326,112.326,149.326,167.326,117.326,142.326,107.326,118.326,189.326,149.326,183.326,173.326,204.326,284.326,255.326,325.326,306.326,317.326,382.326,353.326,381.326,362.326,342.326,361.326,300.326,304.326,280.326,234.326,240.326,172.326,144.326,42.326,-73.674,-100.674,-268.674,-339.674,-469.674,-576.674,-588.674,-649.674,-641.674,-649.674,-660.674,-598.674,-586.674,-475.674,-397.674,-354.674,-228.674,-199.674,-89.674,-3.674,64.326,225.326,317.326,459.326,563.326,594.326,638.326,611.326,567.326,492.326,335.326,181.326,-27.674,-201.674,-350.674,-514.674,-555.674,-585.674,-553.674,-499.674,-473.674,-330.674,-243.674,-115.674,31.326,42.326,151.326,116.326,83.326,13.326,-132.674,-198.674,-274.674,-292.674,-299.674,-395.674,-391.674,-422.674,-424.674,-355.674,-370.674,-276.674,-234.674,-196.674,-122.674,-163.674,-95.674,-48.674,41.326,222.326,298.326,438.326,501.326,552.326,618.326,554.326,550.326,487.326,400.326,401.326,298.326,297.326,228.326,120.326,157.326,37.326,46.326,-19.674,-78.674,-17.674,-104.674,-36.674,-26.674,-73.674,31.326,-2.674,100.326,107.326,80.326,177.326,115.326,204.326,193.326,119.326,182.326,109.326,165.326,169.326,85.326,147.326,77.326,104.326,143.326,45.326,93.326,32.326,90.326,110.326,40.326,107.326,35.326,89.326,149.326,57.326,106.326,62.326,78.326,110.326,7.326,57.326,12.326,43.326,94.326,-13.674,52.326,-0.674,22.326,78.326,-22.674,33.326,-8.674,7.326,53.326,-28.674,11.326,-46.674,-66.674,-21.674,-80.674,-41.674,-85.674,-105.674,-77.674,-144.674,-111.674,-142.674,-153.674,-86.674,-142.674,-89.674,-99.674,-135.674,-36.674,-82.674,-25.674,-42.674,-49.674,14.326,-85.674,-48.674,-82.674,12.326,-19.674,45.326,58.326,43.326,135.326,107.326,179.326,219.326,171.326,246.326,235.326,294.326,315.326,290.326,342.326,298.326,354.326,371.326,301.326,371.326,316.326,350.326,371.326,286.326,340.326,287.326,312.326,326.326,221.326,277.326,211.326,234.326,260.326,170.326,207.326,144.326,160.326,175.326,48.326,109.326,42.326,77.326,100.326,-20.674,48.326,-11.674,13.326,38.326,-56.674,-11.674,-69.674,-47.674,-14.674,-83.674,-30.674,-88.674,-92.674,-35.674,-114.674,-74.674,-114.674,-142.674,-74.674,-168.674,-108.674,-149.674,-186.674,-121.674,-198.674,-145.674,-171.674,-218.674,-149.674,-223.674,-166.674,-205.674,-228.674,-162.674,-216.674,-175.674,-195.674,-236.674,-167.674,-217.674,-168.674,-168.674,-218.674,-152.674,-209.674,-153.674,-138.674,-203.674,-141.674,-165.674,-116.674,-114.674,-155.674,-102.674,-147.674,-102.674,-85.674,-114.674,-88.674,-113.674,-76.674,-30.674,-81.674,-37.674,-64.674,-27.674,31.326,-43.674,14.326,-38.674,-4.674,40.326,-36.674,13.326,-31.674,16.326,42.326,-21.674,24.326,-15.674,29.326,83.326,-1.674,46.326,19.326,45.326,115.326,37.326,88.326,48.326,61.326,114.326,53.326,95.326,42.326,35.326,100.326,26.326,64.326,41.326,10.326,57.326,-14.674,40.326,-5.674,-17.674,45.326,-3.674,31.326,-16.674,-23.674,52.326,-12.674,38.326,32.326,11.326,60.326,25.326,79.326,54.326,38.326,107.326,52.326,105.326,94.326,44.326,108.326,57.326,98.326,97.326,42.326,111.326,81.326,106.326,105.326,47.326,106.326,53.326,106.326,104.326,40.326,98.326,44.326,60.326,100.326,40.326,96.326,35.326,56.326,89.326,-0.674,46.326,13.326,43.326,46.326,-7.674,37.326,-6.674,35.326,46.326,-22.674,35.326,-19.674,8.326,22.326,-49.674,-8.674,-42.674,-21.674,19.326,-50.674,-18.674,-41.674,-32.674,5.326,-43.674,-21.674,-65.674,-46.674,-1.674,-71.674,-21.674,-41.674,-48.674,-20.674,-66.674,-29.674,-40.674,-51.674,-1.674,-50.674,-20.674,-50.674,-47.674,22.326,-46.674,-9.674,-20.674,-32.674,25.326,-21.674,25.326,-1.674,-11.674,30.326,-18.674,41.326,26.326,-21.674,-77.674,-33.674,-24.674,-67.674,-8.674,-44.674,-21.674,-15.674,-31.674,-4.674,-40.674,-4.674,26.326,-27.674,26.326,-26.674,-1.674,41.326,-15.674,29.326,-17.674,30.326,56.326,0.326,43.326,-4.674,40.326,89.326,-1.674,47.326,-2.674,36.326,76.326,14.326,43.326,0.326,42.326,75.326,12.326,41.326,12.326,43.326,80.326,12.326,50.326,7.326,34.326,89.326,25.326,55.326,21.326,29.326,78.326,25.326,53.326,30.326,29.326,55.326,14.326,46.326,19.326,0.326,52.326,-13.674,35.326,13.326,-14.674,45.326,-0.674,43.326,24.326,-19.674,52.326,-3.674,41.326,22.326,-23.674,42.326,-24.674,20.326,-0.674,-32.674,31.326,-16.674,34.326,24.326,-42.674,23.326,-28.674,-2.674,-14.674,-43.674,12.326,-43.674,-2.674,2.326,-40.674,15.326,-32.674,-2.674,34.326,-49.674,13.326,-33.674,4.326,31.326,-49.674,8.326,-30.674,-13.674,22.326,-66.674,-2.674,-44.674,-23.674,13.326,-85.674,-17.674,-51.674,-26.674,1.326,-77.674,-12.674,-63.674,-21.674,33.326,-71.674,0.326,-71.674,-24.674,15.326,-73.674,-19.674,-47.674,-39.674,24.326,-52.674,-1.674,-28.674,-27.674,35.326,-33.674,14.326,-12.674,-16.674,36.326,-24.674,28.326,-11.674,-23.674,41.326,-24.674,34.326,17.326,-39.674,33.326,-24.674,26.326,17.326,-30.674,43.326,-25.674,39.326,41.326,6.326,54.326,-6.674,56.326,45.326,14.326,61.326,1.326,60.326,54.326,2.326,47.326,13.326,47.326,60.326,-11.674,54.326,-12.674,42.326,63.326,-20.674,40.326,-27.674,29.326,61.326,-18.674,20.326,-21.674,33.326,86.326,-17.674,38.326,-22.674,28.326,55.326,-25.674,12.326,-27.674,-3.674,42.326,-32.674,-3.674,-41.674,-9.674,57.326,-24.674,20.326,-41.674,-10.674,41.326,-32.674,13.326,-34.674,-24.674,29.326,-44.674,5.326,-33.674,-31.674,32.326,-42.674,-2.674,-25.674,-31.674,25.326,-41.674,7.326,-30.674,-44.674,31.326,-33.674,-3.674,-15.674,-54.674,20.326,-32.674,32.326,-19.674,-40.674,20.326,-34.674,20.326,-20.674,-72.674,21.326,-39.674,-19.674,-24.674,-68.674,1.326,-48.674,33.326,-26.674,37.326,-16.674,33.326,36.326,-23.674,23.326,-19.674,26.326,42.326,-25.674,42.326,-20.674,37.326,45.326,-38.674,42.326,-16.674,42.326,69.326,-33.674,42.326,-21.674,31.326,48.326,-43.674,25.326,-20.674,25.326,47.326,-46.674,23.326,-22.674,-8.674,40.326,-57.674,-0.674,-50.674,-23.674,30.326,-63.674,-9.674,-30.674,-35.674,25.326,-66.674,-0.674,-44.674,-34.674,34.326,-42.674,12.326,-26.674,-33.674,32.326,-39.674,-1.674,-20.674,-33.674,27.326,-44.674,-2.674,-20.674,-40.674,26.326,-46.674,-2.674,-26.674,-65.674,12.326,-47.674,-4.674,-17.674,-67.674,11.326,-51.674,-12.674,-10.674,-48.674,24.326,-41.674,-2.674,-3.674,-44.674,0.326,-51.674,-17.674,10.326,-63.674,-15.674,-71.674,-10.674,18.326,-35.674,16.326,-34.674,29.326,39.326,-31.674,23.326,-30.674,-10.674,25.326,-34.674,8.326,-34.674,-11.674,44.326,-22.674,8.326,-32.674,13.326,30.326,-40.674,16.326,-46.674,-7.674,42.326,-24.674,29.326,-31.674,-12.674,51.326,-25.674,24.326,-22.674,-5.674,45.326,-21.674,22.326,-20.674,-21.674,42.326,-31.674,28.326,-24.674,-26.674,43.326,-20.674,21.326,1.326,-11.674,41.326,-21.674,15.326,-10.674,-24.674,28.326,-31.674,-3.674,-12.674,-46.674,8.326,-35.674,23.326,-6.674,-50.674,20.326,-21.674,27.326,-10.674,-47.674,19.326,-27.674,24.326,0.326,-40.674,14.326,-26.674,-1.674,20.326,-28.674,-3.674,-21.674,15.326,13.326,-31.674,-1.674,-43.674,15.326,29.326,-41.674,19.326,-25.674,-11.674,42.326,-32.674,23.326,-11.674,16.326,46.326,-11.674,28.326,-2.674,34.326,82.326,-12.674,38.326,1.326,36.326,69.326,5.326,52.326,24.326,39.326,75.326,-1.674,37.326,-0.674,23.326,51.326,-11.674,39.326,-20.674,-23.674,41.326,-42.674,-7.674,-38.674,-44.674,30.326,-76.674,-15.674,-46.674,-56.674,-4.674,-84.674,-21.674,-49.674,-79.674,-13.674,-85.674,-34.674,-46.674,-78.674,-3.674,-77.674,-17.674,-33.674,-82.674,-21.674,-71.674,-21.674,-30.674,-87.674,-21.674,-73.674,-30.674,-24.674,-70.674,-21.674,-44.674,-19.674,-12.674,-67.674,77.326,107.326,101.326,22.326,40.326,-15.674,-5.674,19.326,-41.674,-4.674,-38.674,11.326,53.326,-21.674,36.326,-3.674,44.326,76.326,-5.674,53.326,6.326,15.326,53.326,-20.674,19.326,-17.674,-0.674,52.326,-16.674,33.326,-7.674,31.326,60.326,-6.674,37.326,14.326,35.326,82.326,-1.674,38.326,14.326,-9.674,49.326,-14.674,23.326,-14.674,-21.674,41.326,-21.674,14.326,-27.674,-36.674,27.326,-40.674,-14.674,-32.674,-51.674,12.326,-51.674,-14.674,-34.674,-48.674,13.326,-24.674,-10.674,-25.674,-49.674,-8.674,-24.674,-21.674,-27.674,-52.674,13.326,-36.674,-8.674,-11.674,-52.674,-14.674,-29.674,-13.674,-12.674,-38.674,4.326,-30.674,-11.674,-3.674,-46.674,0.326,-37.674,-21.674,-1.674,-65.674,-9.674,-33.674,-14.674,-4.674,-66.674,-21.674,-38.674,-21.674,-12.674,-82.674,-20.674,-65.674,-27.674,-10.674,-67.674,-18.674,-45.674,-29.674,-4.674,-66.674,-20.674,-51.674,-30.674,-11.674,-66.674,-21.674,-41.674,-27.674,24.326,-43.674,-16.674,-22.674,-10.674,29.326,-21.674,15.326,-19.674,-16.674,27.326,-37.674,-8.674,-19.674,-36.674,34.326,-31.674,-8.674,-29.674,-45.674,-5.674,-41.674,-17.674,-29.674,-48.674,-6.674,-67.674,-12.674,-23.674,-44.674,-13.674,-41.674,6.326,-9.674,-34.674,-3.674,-49.674,-12.674,-13.674,-46.674,-21.674,-36.674,-28.674,-22.674,-50.674,-19.674,-79.674,-26.674,-21.674,-76.674,-24.674,-73.674,-35.674,-9.674,-64.674,-18.674,-67.674,-35.674,-17.674,-48.674,-20.674,-50.674,-28.674,19.326,-64.674,-16.674,-43.674,-21.674,23.326,-55.674,-11.674,-36.674,-21.674,22.326,-48.674,-12.674,-46.674,-25.674,30.326,-26.674,14.326,-25.674,-26.674,31.326,-39.674,-9.674,-34.674,-27.674,23.326,-29.674,-9.674,-35.674,-29.674,15.326,-33.674,-11.674,-33.674,-34.674,15.326,-56.674,-14.674,-27.674,-51.674,21.326,-38.674,-12.674,-24.674,-67.674,14.326,-33.674,-6.674,-27.674,-75.674,11.326,-49.674,1.326,-20.674,-41.674,22.326,-40.674,4.326,21.326,-44.674,11.326,-41.674,7.326,31.326,-42.674,15.326,-23.674,5.326,31.326,-26.674,26.326,-20.674,24.326,-6.674,43.326,-1.674,39.326,43.326,-26.674,25.326,-14.674,23.326,43.326,-40.674,23.326,-19.674,21.326,42.326,-43.674,28.326,-33.674,13.326,30.326,-38.674,12.326,-36.674,-7.674,42.326,-38.674,-9.674,-34.674,-32.674,16.326,-65.674,-3.674,-49.674,-31.674,18.326,-47.674,-9.674,-42.674,-48.674,14.326,-67.674,-19.674,-38.674,-51.674,3.326,-69.674,-10.674,-22.674,-51.674,-0.674,-67.674,-11.674,-31.674,-68.674,19.326,-67.674,-15.674,-16.674,-50.674,-3.674,-51.674,-18.674,-36.674,-46.674,-15.674,-49.674,-21.674,-17.674,-48.674,19.326,-43.674,-18.674,-16.674,-79.674,-12.674,-43.674,-9.674,-2.674,-41.674,1.326,-40.674,-18.674,-12.674,-74.674,-7.674,-30.674,11.326,22.326,-36.674,6.326,-34.674,-14.674,35.326,-34.674,27.326,-24.674,11.326,38.326,-31.674,21.326,-29.674,-9.674,35.326,-51.674,6.326,-40.674,-21.674,37.326,-32.674,6.326,-28.674,-22.674,24.326,-44.674,-3.674,-44.674,-22.674,33.326,-43.674,-3.674,-47.674,-31.674,21.326,-40.674,-10.674,-28.674,-44.674,26.326,-27.674,7.326,-32.674,-49.674,29.326,-31.674,-17.674,-42.674,-76.674,-2.674,-70.674,-16.674,-33.674,-85.674,-13.674,-84.674,-21.674,-43.674,-84.674,-17.674,-78.674,-26.674,-47.674,-93.674,-31.674,-85.674,-27.674,-37.674,-84.674,-26.674,-71.674,-25.674,-31.674,-95.674,-42.674,-77.674,-43.674,-33.674,-86.674,-42.674,-75.674,-39.674,-22.674,-85.674,-33.674,-79.674,-50.674,-33.674,-89.674,-41.674,-85.674,-64.674,-28.674,-85.674,-34.674,-82.674,-43.674,-10.674,-91.674,-24.674,-77.674,-37.674,-4.674,-88.674,-25.674,-70.674,-50.674,-7.674,-76.674,-21.674,-47.674,-22.674,11.326,-67.674,-17.674,-38.674,-23.674,22.326,-38.674,-7.674,-25.674,-33.674,28.326,-21.674,26.326,-12.674,-21.674,24.326,-24.674,22.326,-21.674,-17.674,31.326,-16.674,22.326,13.326,-14.674,40.326,-21.674,21.326,16.326,-21.674,30.326,-12.674,27.326,40.326,-11.674,47.326,-3.674,49.326,44.326,12.326,51.326,22.326,80.326,91.326,37.326,94.326,43.326,83.326,86.326,20.326,47.326,-4.674,45.326,55.326,16.326,55.326,-543.674,-519.674,-493.674,-363.674,-284.674,-119.674,40.326,79.326,204.326,208.326,248.326,288.326,191.326,205.326,111.326,88.326,81.326,-28.674,-36.674,-93.674,-98.674,-71.674,-126.674,-81.674,-113.674,-91.674,-51.674,-95.674,-21.674,-73.674,-31.674,42.326,21.326,79.326,54.326,76.326,144.326,102.326,125.326,106.326,97.326,153.326,95.326,116.326,93.326,60.326,107.326,75.326,106.326,78.326,42.326,100.326,45.326,60.326,52.326,22.326,54.326,25.326,48.326,34.326,-12.674,41.326,-12.674,16.326,-3.674,-33.674,17.326,-18.674,2.326,15.326,-26.674,20.326,-19.674,9.326,28.326,-22.674,13.326,-23.674,23.326,48.326,-17.674,36.326,-5.674,44.326,60.326,15.326,36.326,9.326,38.326,51.326,-11.674,36.326,-21.674,22.326,43.326,-27.674,24.326,-21.674,12.326,42.326,-34.674,17.326,-23.674,-17.674,17.326,-69.674,-34.674,-87.674,-58.674,-24.674,-103.674,-80.674,-132.674,-104.674,-84.674,-149.674,-104.674,-137.674,-148.674,-95.674,-155.674,-103.674,-136.674,-135.674,-67.674,-131.674,-66.674,-43.674,-47.674,39.326,11.326,87.326,109.326,108.326,216.326,212.326,275.326,305.326,304.326,407.326,375.326,422.326,429.326,396.326,452.326,395.326,420.326,387.326,312.326,335.326,220.326,213.326,167.326,57.326,39.326,-55.674,-74.674,-112.674,-209.674,-207.674,-277.674,-281.674,-300.674,-396.674,-360.674,-408.674,-398.674,-354.674,-417.674,-387.674,-421.674,-394.674,-340.674,-394.674,-332.674,-353.674,-327.674,-249.674,-303.674,-237.674,-244.674,-224.674,-185.674,-221.674,-168.674,-203.674,-172.674,-121.674,-158.674,-108.674,-147.674,-114.674,-69.674,-92.674,-44.674,-43.674,-33.674,38.326,-23.674,18.326,-4.674,4.326,54.326,20.326,44.326,43.326,22.326,102.326,55.326,94.326,59.326,42.326,87.326,50.326,64.326,45.326,15.326,75.326,0.326,26.326,17.326,-24.674,14.326,-9.674,34.326,39.326,21.326,77.326,42.326,78.326,60.326,31.326,82.326,41.326,85.326,84.326,50.326,89.326,53.326,106.326,100.326,40.326,92.326,43.326,62.326,99.326,36.326,49.326,18.326,32.326,43.326,-8.674,22.326,-33.674,-11.674,22.326,-9.674,-78.674,-46.674,-35.674,-139.674,-91.674,-150.674,-143.674,-128.674,-219.674,-197.674,-235.674,-232.674,-200.674,-285.674,-260.674,-291.674,-280.674,-239.674,-304.674,-259.674,-284.674,-276.674,-230.674,-296.674,-266.674,-301.674,-287.674,-237.674,-326.674,-273.674,-285.674,-323.674,-239.674,-294.674,-222.674,-223.674,-225.674,-139.674,-176.674,-102.674,-97.674,-110.674,-10.674,-45.674,35.326,21.326,-20.674,47.326,-12.674,39.326,30.326,-21.674,39.326,-33.674,-15.674,-26.674,-94.674,-59.674,-128.674,-74.674,-63.674,-129.674,-40.674,-94.674,12.326,79.326,43.326,158.326,157.326,241.326,292.326,226.326,271.326,174.326,207.326,163.326,62.326,47.326,-26.674,-38.674,-40.674,-145.674,-105.674,-167.674,-146.674,-107.674,-167.674,-139.674,-151.674,-120.674,-81.674,-105.674,-68.674,-81.674,-34.674,37.326,-10.674,42.326,24.326,55.326,107.326,50.326,79.326,27.326,18.326,60.326,-13.674,25.326,13.326,19.326,96.326,78.326,149.326,123.326,167.326,239.326,172.326,236.326,227.326,191.326,236.326,164.326,170.326,107.326,29.326,53.326,-67.674,-72.674,-144.674,-206.674,-155.674,-230.674,-199.674,-186.674,-210.674,-133.674,-129.674,-50.674,-21.674,-65.674,28.326,-6.674,83.326,54.326,25.326,85.326,36.326,94.326,84.326,12.326,59.326,-11.674,-3.674,-0.674,-93.674,-69.674,-135.674,-99.674,-92.674,-211.674,-131.674,-206.674,-165.674,-113.674,-214.674,-150.674,-209.674,-170.674,-140.674,-240.674,-151.674,-205.674,-170.674,-123.674,-215.674,-141.674,-169.674,-128.674,-75.674,-161.674,-97.674,-138.674,-113.674,-71.674,-138.674,-73.674,-102.674,-84.674,-17.674,-92.674,-22.674,-58.674,-33.674,22.326,-49.674,15.326,-18.674,-22.674,59.326,-10.674,49.326,36.326,23.326,117.326,58.326,111.326,90.326,76.326,152.326,61.326,125.326,113.326,88.326,158.326,88.326,125.326,114.326,88.326,137.326,98.326,122.326,110.326,54.326,89.326,22.326,28.326,5.326,-48.674,-18.674,-71.674,-48.674,-34.674,-95.674,-65.674,-96.674,-85.674,-77.674,-109.674,-73.674,-98.674,-90.674,-44.674,-89.674,-45.674,-84.674,-36.674,-11.674,-51.674,-10.674,-43.674,-0.674,37.326,-9.674,37.326,-4.674,19.326,-42.674,77.326,106.326,229.326,359.326,355.326,431.326,409.326,461.326,502.326,433.326,475.326,379.326,351.326,352.326,235.326,234.326,165.326,111.326,148.326,43.326,52.326,-12.674,-75.674,-24.674,-144.674,-140.674,-172.674,-192.674,-93.674,-162.674,-97.674,-96.674,-95.674,33.326,-3.674,58.326,54.326,28.326,105.326,57.326,111.326,85.326,42.326,96.326,41.326,75.326,42.326,-34.674,29.326,-41.674,-12.674,1.326,-73.674,0.326,-64.674,-40.674,-23.674,-99.674,-43.674,-93.674,-51.674,-67.674,-127.674,-65.674,-98.674,-47.674,-23.674,-113.674,-72.674,-105.674,-80.674,-52.674,-145.674,-75.674,-106.674,-66.674,-19.674,-96.674,-34.674,-64.674,-36.674,-4.674,-101.674,-16.674,-36.674,-2.674,53.326,-25.674,37.326,9.326,38.326,104.326,37.326,98.326,36.326,62.326,124.326,60.326,132.326,106.326,110.326,165.326,94.326,145.326,107.326,100.326,159.326,96.326,144.326,106.326,105.326,167.326,92.326,143.326,105.326,70.326,125.326,49.326,92.326,80.326,43.326,112.326,76.326,127.326,106.326,81.326,122.326,92.326,148.326,141.326,100.326,156.326,99.326,149.326,144.326,80.326,155.326,101.326,161.326,164.326,106.326,150.326,95.326,151.326,157.326,102.326,147.326,87.326,116.326,152.326,79.326,106.326,44.326,60.326,80.326,-16.674,32.326,-40.674,-15.674,19.326,-78.674,-32.674,-92.674,-75.674,-41.674,-135.674,-91.674,-142.674,-115.674,-79.674,-169.674,-123.674,-163.674,-143.674,-124.674,-196.674,-150.674,-207.674,-177.674,-131.674,-205.674,-155.674,-209.674,-163.674,-132.674,-196.674,-152.674,-192.674,-193.674,-135.674,-183.674,-148.674,-176.674,-184.674,-115.674,-170.674,-130.674,-162.674,-198.674,-129.674,-163.674,-116.674,-145.674,-171.674,-105.674,-153.674,-114.674,-140.674,-151.674,-99.674,-140.674,-98.674,-128.674,-151.674,-87.674,-112.674,-77.674,-82.674,-132.674,-71.674,-101.674,-51.674,-41.674,-97.674,-37.674,-71.674,-25.674,-12.674,-72.674,-20.674,-45.674,-11.674,21.326,-52.674,0.326,-25.674,19.326,42.326,-32.674,34.326,-10.674,43.326,81.326,-2.674,51.326,12.326,43.326,94.326,18.326,56.326,28.326,76.326,93.326,17.326};

const double peaks[3]={49.6, 102.2, 101.2};

double res[2560];

void test1(void);

void test1(void)
{
	int i;
	
//	for (i=0;i<2560;i++)
//	{
//		printf("%f\r\n", src[i]);
//	}
	
	auto_trip_50hz(src, 256, 0.99, peaks, res);
	
	for (i=0;i<2560;i++)
	{
			printf("%d - %lf\r\n", i, res[i]);
	}
}

int main(void)
{
			u16 num = 0;
			HAL_Init();
			Stm32_Clock_Init(200,25,2,7);
			
			delay_init(100);               	//初始化延时函数
			MY_ADC_Init();
			LED_Init();		//初始化LED	 
			
			
			TIM3_Init(40-1,5000-1);        // 100us  3.9ms
			
			
			TIM10_PWM_Init(500-1,100-1);    	//84M/84=1M的计数频率，自动重装载为500，那么PWM频率为1M/500=2kHZ  500-1
			TIM_SetTIM10Compare1(0); 	
			
			TIM4_PWM_Init(500-1,50-1);    	//84M/84=1M的计数频率，自动重装载为500，那么PWM频率为1M/500=2kHZ  500-1
			TIM_SetTIM4Compare1(0); 	
			
			MX_GPIO_Init();
			MX_CRC_Init();
			MX_USART1_UART_Init();
		 
//			printf("test\r\n");
			
			while (1)
			{
					num++;
					//printf("test\r\n");
					
				
				  if(change_flag==1)
					{
						 measure_fft();
						 change_flag=0;
					}
					
					delay_ms(100);
					
					test1();
//					 for(num=0;num<2560;num++)
//					 {
//							adc_data = in_data[num]; 
//							printf("%d ",adc_data);	
//					 }
//					 
//					 printf("END \r\n");
					
			}
  
}



/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */

  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{ 
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     tex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */


